<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Downloader</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <!-- <link rel='stylesheet' type='text/css' media='screen' href='main.css'> -->
    <style>
        table, th, td {
            border: 1px solid black;
            padding-left: 5px;
        }

        table {
            padding-top: 10ch;
        }
        #header {
            position: fixed;
            background: white;
            margin-top: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="header">
        <input type="file" id="file" name="file" multiple style="border: 1px solid black; padding: 1px">
        <button id="upload" onclick="load()">Load</button>
        <br>
        <label for="filter">Filter: (song) => </label>
        <input type="text" id="filter" name="filter">
        <button id="filterButton" onclick="filter()">Filter</button>
        <br>
        <button id="download" onclick="copyIndicies()">Get Download</button>
    </div>
    <table>
        <thead>
            <tr>
                <th><input type="checkbox"></th>
                <th>Image</th>
                <th>Title</th>
                <th>Author</th>
                <th>Difficulty</th>
            </tr>
        </thead>
        <tbody id="tbody">
            
        </tbody>
    </table>
    <script>
        var db = [];
        var display = [];
        // var indexedDB;
        // const openReq = window.indexedDB.open("dtxdb", 1);

        // openReq.addEventListener("error", (e) => {
        //     console.log("Error opening database");
        //     console.log(e);
        // });

        // openReq.addEventListener("success", (e) => {
        //     console.log("Database opened successfully");
            
        //     indexedDB = openReq.result;
        // });

        // openReq.addEventListener("upgradeneeded", (e)=> {
        //     indexedDB = e.target.result;

        //     const objectStore = indexedDB.createObjectStore("dtx", {keyPath: "id", autoIncrement: true});
        //     objectStore.createIndex("title", "title", {unique: false});
        //     objectStore.createIndex("artist", "artist", {unique: false});
        //     objectStore.createIndex("difficulties", "difficulties", {unique: false});
        //     objectStore.createIndex("imgURL", "imgURL", {unique: false});
        //     objectStore.createIndex("dlURL", "dlURL", {unique: false});

        //     console.log("Database upgraded successfully");
        // })
        if (localStorage.getItem("db") != null) {
            db = JSON.parse(localStorage.getItem("db"));
            display = db;
            populate();
        }
        function filter() {
            const filter = new Function("song", "return " + document.getElementById("filter").value);
            display = db.filter(filter);
            populate();
        }

        async function load() {
            /** @type {File} */
            let file = document.getElementById("file").files[0];
            //parse as json
            db = JSON.parse(await file.text());
            localStorage.setItem("db", JSON.stringify(db));
            display = db;
            populate();
        }
        function populate() {
            //clear table
            let tbody = document.getElementById("tbody");
            tbody.innerHTML = "";
            //add rows
            for (let i = 0; i < display.length; i++) {
                let row = makeRow(display[i]);
                tbody.appendChild(row);
            }
        }
        function makeRow(dtxObj) {
            let row = document.createElement("tr");

            let check = document.createElement("input");
            check.type = "checkbox";
            let checkCell = document.createElement("td");
            checkCell.appendChild(check);

            let img = document.createElement("img");
            img.src = dtxObj.imgURL;
            img.width = 64;
            img.height = 64;
            let imgCell = document.createElement("td");
            imgCell.appendChild(img);

            let title = document.createElement("td");
            title.innerText = dtxObj.title;

            let author = document.createElement("td");
            author.innerText = dtxObj.artist;

            let diff = document.createElement("td");
            diff.innerText = dtxObj.difficulties.join(" / ")

            row.appendChild(checkCell);
            row.appendChild(imgCell);
            row.appendChild(title);
            row.appendChild(author);
            row.appendChild(diff);

            return row;
        }

        function copyIndicies() {
            const tbody = document.getElementById("tbody");
            let selectedSongs = []
            for (let i = 0; i < tbody.children.length; i++) {
                if (tbody.children[i].children[0].children[0].checked) {
                    selectedSongs.push(display[i]);
                }
            }

            let indicies = selectedSongs.map(song => db.indexOf(song));
            navigator.clipboard.writeText(JSON.stringify(indicies));
        }
    </script>
</body>
</html>